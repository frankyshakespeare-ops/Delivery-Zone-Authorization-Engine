<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Guard | Delivery Control Tower</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 600px; border-radius: 12px; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-900 font-sans text-slate-200">

    <div class="container mx-auto p-6">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-sky-400">Geo-Guard <span class="text-slate-500 text-lg font-normal">v3.0</span></h1>
                <p class="text-slate-400">Moteur d'Autorisation de Zone & IA Spatial</p>
            </div>
            <div class="flex gap-4">
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <span class="text-xs uppercase text-slate-500 block">Status Serveur</span>
                    <span class="text-green-400 font-mono">● OPÉRATIONNEL</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-slate-800 p-5 rounded-xl border border-slate-700">
                    <h3 class="text-sm font-semibold text-slate-400 mb-4 uppercase">Alertes Anomalies</h3>
                    <div id="anomaly-count" class="text-5xl font-bold text-rose-500">0</div>
                    <p class="text-xs text-slate-500 mt-2">Livreurs hors limite de ville</p>
                </div>
                
                <div class="bg-slate-800 p-5 rounded-xl border border-slate-700">
                    <h3 class="text-sm font-semibold text-slate-400 mb-2 uppercase">Légende</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center gap-2"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Zone de Livraison</li>
                        <li class="flex items-center gap-2"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Frontière Nairobi</li>
                    </ul>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-slate-800 p-2 rounded-2xl border border-slate-700 shadow-2xl">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialisation de la carte sur Nairobi
        const map = L.map('map').setView([-1.286389, 36.817223], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Stockage des marqueurs pour mise à jour fluide
        let driverMarkers = {};

        // 1. Charger les zones (statique)
        fetch('/zones/geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    style: (f) => ({
                        color: f.properties.category === 'city_boundary' ? '#f43f5e' : '#10b981',
                        fillOpacity: 0.1,
                        weight: 2,
                        dashArray: f.properties.category === 'city_boundary' ? '5, 10' : '0'
                    })
                }).addTo(map);
            });

        // 2. Fonction de mise à jour des positions
        function updateDrivers() {
            fetch('/drivers/positions')
                .then(res => res.json())
                .then(drivers => {
                    let anomaliesCount = 0;

                    drivers.forEach(d => {
                        if (d.is_anomaly) anomaliesCount++;

                        const color = d.is_anomaly ? "#f43f5e" : "#0ea5e9"; // Rouge si anomalie, Bleu si OK
                        
                        if (driverMarkers[d.id]) {
                            // Si le marqueur existe déjà, on le déplace simplement
                            driverMarkers[d.id].setLatLng([d.lat, d.lon]);
                            driverMarkers[d.id].setStyle({ fillColor: color });
                        } else {
                            // Sinon, on le crée
                            driverMarkers[d.id] = L.circleMarker([d.lat, d.lon], {
                                radius: 5,
                                fillColor: color,
                                color: "#fff",
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.9
                            }).addTo(map).bindTooltip(`ID: ${d.id}`);
                        }
                    });
                    
                    document.getElementById('anomaly-count').innerText = anomaliesCount;
                });
        }

        // Update initial
        updateDrivers();

        // Rafraîchissement toutes les 3 secondes (temps réel simulé)
        setInterval(updateDrivers, 3000);
    </script>
</body>
</html>