<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Geo-Guard | Delivery Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #222c4b; color: #0d1420; }
        #map { height: 100%; width: 100%; border-radius: 18px; z-index: 100; }
        .stats-circle { border: 4px solid #e2e8f0; border-top-color: #3b82f6; transition: 0.3s; }
        .log-container::-webkit-scrollbar { width: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen overflow-hidden flex p-6 gap-6">

    <aside class="w-1/4 flex flex-col gap-6">
        <div class="bg-white p-6 rounded-[18px] shadow-sm border border-slate-100">
                <div class="bg-white p-2 rounded-xl text-white mb-4 flex items-center gap-3">
                    <img src="logo.png" class="w-12 h-12 bg-blue-600 p-2 rounded-xl">

            <div class="flex flex-col">
                <h1 class="text-[26px] font-bold text-blue-600">Geo-Guard</h1>
                <p class="text-[9px] text-slate-400 font-bold tracking-widest">
                    Zone authorization engine & spatial AI
                </p>

            </div> 

        </div>

            <h2 class="text-slate-400 text-sm font-semibold uppercase mb-4">My Analytics</h2>
            <div class="flex justify-between mb-8">
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full stats-circle flex items-center justify-center text-lg font-bold" id="total-drivers">0</div>
                    <span class="text-[10px] text-slate-400 mt-2 block">Drivers</span>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full stats-circle flex items-center justify-center text-lg font-bold border-rose-400" id="anomaly-count">0</div>
                    <span class="text-[10px] text-slate-400 mt-2 block">Alertes</span>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full stats-circle flex items-center justify-center text-lg font-bold border-green-400">98%</div>
                    <span class="text-[10px] text-slate-400 mt-2 block">Efficiency</span>
                </div>
            </div>

            <h3 class="font-bold text-sm mb-3 flex justify-between">
                Live Feed <span class="text-blue-500 text-[10px] animate-pulse">‚óè LIVE</span>
            </h3>
            <div id="logs" class="log-container h-64 overflow-y-auto space-y-3 pr-2">
                </div>
        </div>

        <div class="bg-white p-6 rounded-[18px] shadow-sm flex-1 border border-slate-100 overflow-hidden flex flex-col">
            <h3 class="font-bold text-sm mb-4">Hot Zones</h3>
            <div id="neighborhoods" class="space-y-4 overflow-y-auto flex-1 pr-20 text-sm text-slate-600">
                </div>
        </div>
    </aside>

    <main class="flex-1 relative">
        <div id="map" class="shadow-xl shadow-blue-100/50"></div>
        
        <div class="absolute top-6 right-6 z-[1000] flex gap-2">
            <button onclick="toggleHeat()" class="bg-white/90 backdrop-blur-md px-4 py-2 rounded-full shadow-lg text-sm font-bold border border-slate-100 hover:bg-blue-50 transition">
                üî• Toggle Heatmap
            </button>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
    
    <script>
        const map = L.map('map', { zoomControl: false }).setView([-1.286, 36.817], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let driverMarkers = {};
        let heatLayer = null;
        let showHeat = false;

        // Logs system
        function addLog(msg, type = 'info') {
            const container = document.getElementById('logs');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const color = type === 'alert' ? 'text-rose-500 bg-rose-50' : 'text-slate-600 bg-slate-50';
            const html = `<div class="p-3 rounded-2xl text-[11px] ${color}">
                            <strong>${time}</strong> - ${msg}
                          </div>`;
            container.insertAdjacentHTML('afterbegin', html);
            if(container.children.length > 20) container.lastElementChild.remove();
        }

        // Zones & Quartiers
         fetch('/zones/geojson').then(r => r.json()).then(data => {
            const list = document.getElementById('neighborhoods');
            zonesLayer = L.geoJSON(data, {
                style: (f) => {
                    if (f.properties.category === 'city_boundary') {
                        return { color: '#10b981', weight: 2, fillOpacity: 0.05, dashArray: '5, 10' }; // Super Zone Verts
                    }
                    return { color: '#3b82f6', weight: 1, fillOpacity: 0.20 }; // Quartiers Bleue
                },
                onEachFeature: (f, l) => {
                    if(f.properties.category === 'delivery') {
                        list.insertAdjacentHTML('beforeend', `<div class="p-2 bg-slate-800/30 rounded-lg border border-slate-700/50 text-slate-400">${f.properties.name}</div>`);
                        
                        // Effet Hover
                        l.on('mouseover', function() {
                            this.setStyle({ fillOpacity: 0.4, weight: 2, color: '#34d399' });
                            this.bindTooltip(f.properties.name).openTooltip();
                        });
                        l.on('mouseout', function() {
                            zonesLayer.resetStyle(this);
                        });
                    }
                }
            }).addTo(map);
            map.fitBounds(zonesLayer.getBounds());
        });

        function updatePositions() {
            fetch('/drivers/positions').then(r => r.json()).then(drivers => {
                let heatData = [];
                let currentAnomalies = 0;

                drivers.forEach(d => {
                    heatData.push([d.lat, d.lon, 0.5]);
                    if(d.is_anomaly) currentAnomalies++;

                    const color = d.is_anomaly ? "#f43f5e" : "#3b82f6";
                    
                    if(d.is_anomaly && !driverMarkers[d.id]?.wasAnomaly) {
                        addLog(`Alerte: Driver ${d.id} is out of range !`, 'alert');
                    }

                    if (driverMarkers[d.id]) {
                        driverMarkers[d.id].setLatLng([d.lat, d.lon]).setStyle({fillColor: color});
                    } else {
                        driverMarkers[d.id] = L.circleMarker([d.lat, d.lon], {
                            radius: 6, fillColor: color, color: "#fff", weight: 1, fillOpacity: 1
                        }).addTo(map);
                        addLog(`Driver ${d.id} is online`);
                    }
                    driverMarkers[d.id].wasAnomaly = d.is_anomaly;
                });

                // Update Stats
                document.getElementById('total-drivers').innerText = drivers.length;
                document.getElementById('anomaly-count').innerText = currentAnomalies;

                // Update Heatmap
                if(heatLayer) map.removeLayer(heatLayer);
                heatLayer = L.heatLayer(heatData, {radius: 25, blur: 15, max: 1.0, gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}});
                if(showHeat) heatLayer.addTo(map);
            });
        }

        function toggleHeat() {
            showHeat = !showHeat;
            if(showHeat) heatLayer.addTo(map); else map.removeLayer(heatLayer);
        }

        setInterval(updatePositions, 3000);
        updatePositions();
    </script>
</body>
</html>